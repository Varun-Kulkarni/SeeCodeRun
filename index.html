<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  
  <!-- Comment by Dana -->
  <!-- Includes -->
	<script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>
	<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<!--  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css"> -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

	<!-- ACE and its JavaScript mode and theme files -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/ace.js"></script>

	<!-- Firepad -->
	<link rel="stylesheet" href="https://cdn.firebase.com/libs/firepad/1.2.0/firepad.css" />
	<script src="https://cdn.firebase.com/libs/firepad/1.2.0/firepad.min.js"></script>

	<!-- Esprima -->
	<!--<script src="include/require.js"></script>-->
	<script src="include/esprima.js"></script>
	<!--<script src="include/escodegen.js"></script>-->

	<!-- Stylesheet -->
	<link rel="stylesheet" href="styles.css" />

</head>

<body>
  <div class="container-fluid">
  	<div class="row">
	  <div class="col-md-5" style="padding-left: 0px; padding-right: 0px">	  
	  	<div role="tabpanel" >
		  	<ul class="nav nav-tabs">
	  			<li role="presentation" class="active">
	  				<a href="#js-container" aria-controls="js-container" role="tab" data-toggle="tab">js</a></li>
	  			<li role="presentation">
	  				<a href="#html-container" aria-controls="html-container" role="tab" data-toggle="tab">html</a></li>
	  			<li role="presentation">
	  				<a href="#css-container" aria-controls="css-container" role="tab" data-toggle="tab">css</a></li>
			</ul>
		  
			<div class="tab-content">	  
		  		<div role="tabpanel" class="tab-pane active" id="js-container" >
		  			<div id="aceJSEditorDiv" style="height: 700px"></div></div>
			  	<div role="tabpanel" class="tab-pane" id="html-container">
			  		<div id="aceHTMLEditorDiv" style="height: 700px"></div></div>
			  	<div role="tabpanel" class="tab-pane" id="css-container">
			  		<div id="aceCSSEditorDiv" style="height: 700px"></div></div>
			</div>
		</div>
		

	    <!-- <button onClick="updateIframe();" id="runCode" class="btn btn-default btn-primary" >Run</button> -->
	  </div>
	  <div class="col-md-7" style="padding-left: 2px; padding-right: 2px">
	  		<div id="html-output"><iframe id="preview" style="height: 650px; width: 100%"></iframe></div>
	  		<div id="console-output"></div>
	  </div>
  	</div>
  </div>
  


<script>
	"use strict";
	//var escodegen = require('escodegen');
	//var esprima = require('esprima');
	/*
	    Syntax = {
        AssignmentExpression: 'AssignmentExpression',
        AssignmentPattern: 'AssignmentPattern',
        ArrayExpression: 'ArrayExpression',
        ArrayPattern: 'ArrayPattern',
        ArrowFunctionExpression: 'ArrowFunctionExpression',
        BlockStatement: 'BlockStatement',
        BinaryExpression: 'BinaryExpression',
        BreakStatement: 'BreakStatement',
        *********CallExpression: 'CallExpression',
        CatchClause: 'CatchClause',
        ClassBody: 'ClassBody',
        ClassDeclaration: 'ClassDeclaration',
        ClassExpression: 'ClassExpression',
        *********ConditionalExpression: 'ConditionalExpression',
        ContinueStatement: 'ContinueStatement',
        *********DoWhileStatement: 'DoWhileStatement',
        DebuggerStatement: 'DebuggerStatement',
        EmptyStatement: 'EmptyStatement',
        ExportAllDeclaration: 'ExportAllDeclaration',
        ExportDefaultDeclaration: 'ExportDefaultDeclaration',
        ExportNamedDeclaration: 'ExportNamedDeclaration',
        ExportSpecifier: 'ExportSpecifier',
        ExpressionStatement: 'ExpressionStatement',
        *********ForStatement: 'ForStatement',
        ForInStatement: 'ForInStatement',
        FunctionDeclaration: 'FunctionDeclaration',
        *********FunctionExpression: 'FunctionExpression',
        Identifier: 'Identifier',
        *********IfStatement: 'IfStatement',
        ImportDeclaration: 'ImportDeclaration',
        ImportDefaultSpecifier: 'ImportDefaultSpecifier',
        ImportNamespaceSpecifier: 'ImportNamespaceSpecifier',
        ImportSpecifier: 'ImportSpecifier',
        Literal: 'Literal',
        LabeledStatement: 'LabeledStatement',
        LogicalExpression: 'LogicalExpression',
        MemberExpression: 'MemberExpression',
        MethodDefinition: 'MethodDefinition',
        NewExpression: 'NewExpression',
        ObjectExpression: 'ObjectExpression',
        ObjectPattern: 'ObjectPattern',
        Program: 'Program',
        Property: 'Property',
        RestElement: 'RestElement',
        *********ReturnStatement: 'ReturnStatement',
        SequenceExpression: 'SequenceExpression',
        SpreadElement: 'SpreadElement',
        Super: 'Super',
        SwitchCase: 'SwitchCase',
        SwitchStatement: 'SwitchStatement',
        TaggedTemplateExpression: 'TaggedTemplateExpression',
        TemplateElement: 'TemplateElement',
        TemplateLiteral: 'TemplateLiteral',
        ThisExpression: 'ThisExpression',
        ThrowStatement: 'ThrowStatement',
        TryStatement: 'TryStatement',
        UnaryExpression: 'UnaryExpression',
        UpdateExpression: 'UpdateExpression',
        VariableDeclaration: 'VariableDeclaration',
        VariableDeclarator: 'VariableDeclarator',
        *********WhileStatement: 'WhileStatement',
        WithStatement: 'WithStatement'
    };
	*/
	
	
	// Get Value of a Statement #20 Issue
	// 1) assignment statements: value of variable being assigned
	//		Expression Statement
	//		AssignmentExpression
	// 2) conditional statements: true or false
	//		IfStatement
	//		SwitchStatement
	// 3) loops: total number of times loop executed
	//		WhileStatement
	//		ForStatement		
	// 4) function invocations: return value of function
	//		ReturnStatement
    esprimaParsing();
	function esprimaParsing(){
		console.log("running parsing");	
		var syntaxTree = esprima.parse('if(x==5){};while(p==true){};',1);
		//var recreateCode = escodegen.generate(syntaxTree,1);
		//console.log(recreateCode);
		console.log("retrieving types of statements...")
		traverse(syntaxTree, function(node) {
			if(node.type==="AssignmentExpression"){
				console.log("assignment expression");
			}			
			else if(node.type==="IfStatement"){
				console.log("conditional statements");
			}
			else if(node.type==="ForStatement"||node.type==="WhileStatement"){
				console.log("loops");
			}
			else if(node.type==="CallExpression"||node.type==="FunctionExpression"||node.type==="ReturnStatement"){
				console.log("function invocations")
			}
    	});
		//traverse(syntax, function(node){alert(node.type)});
		//showType(syntax);
	}
	function traverse(node, func) {
		//pass the result to the function
	    func(node);//1
	    // iterates through each key element in the node
	    for (var key in node) { //2
	    	// if the node the property for the key
	        if (node.hasOwnProperty(key)) { //3
	        	// retrieve the property from the node
	            var child = node[key];
	            // check to see if the retrieved result is an object and not null
	            if (typeof child === 'object' && child !== null) { //4
	            	// then create an array for the result
	                if (Array.isArray(child)) {
	                	// iterate through each of the element in the array
	                    child.forEach(function(node) { //5
	                        traverse(node, func);
	                    });
	                // if it can't be created as an array, then display the result 
	                } else {
	                    traverse(child, func); //6
	                }
	            }
	        }
	    }
	}
	function traverseX(node){
		var all = "";
		var allBody = "";
		for(var key in node){
			if(key == "body")
				alert(key.type);
				//alert(key[0]);
				//for(var s in key)
				//	allBody+=s+"\n";
			all+=key+"\n";
		}
		alert(all);
		alert(allBody);
	}
	
	// Helper to get hash from end of URL or generate a random one.
	function getUniqueCodeURL(baseURL) {
	  var ref = new Firebase(baseURL);
	  var hash = window.location.hash.replace(/#/g, '');
	  if (hash) {
	    ref = ref.child(hash);
	  } else {
	    ref = ref.push(); // generate unique location.
	    window.location = window.location + '#' + ref.key(); // add it as a hash to the URL.
	  }
	  if (typeof console !== 'undefined')
	    console.log('Firebase data: ', ref.toString());
	  return ref.key();
	}
	
	function onEditorChanged(e)
	{
		// Reset the timeout to update the iframe.	
		clearTimeout(editorChangedTimeout);
		editorChangedTimeout = setTimeout(function() {
			if (!(hasjsErrors || hashtmlErrors || hascssErrors))
				updateIframe();
		}, 2500);
	}

	
	function updateIframe()
	{
		console.log("Updated iFrame");
		
		// Clear the output window
		$('#console-output').html('');
		
		// Populate the iframe with the current html, css, and js.
		$("#preview").contents().find("body").html(htmlEditor.getValue());
		$("#preview").contents().find("head").append('<style>' + cssEditor.getValue() + '</style>'
				+ '<script src="https://code.jquery.com/jquery-2.1.4.min.js"><\/script>'
				+ '<script>' + jsEditor.getValue() + '<\/script>');
	}
	
	// Global vars
	var editorChangedTimeout = null;

	// Initialize Firebase Refs for js, html, and css
	var baseURL = 'https://seecoderun.firebaseio.com';
	var uniqueCodeURL = getUniqueCodeURL(baseURL);
	var jsFirebaseRef = new Firebase(baseURL + '/' + uniqueCodeURL + '/content/js');
	var htmlFirebaseRef = new Firebase(baseURL + '/' + uniqueCodeURL + '/content/html');
	var cssFirebaseRef = new Firebase(baseURL + '/' + uniqueCodeURL + '/content/css');	
	
	// Set up ACE editors and firepads for js, html, and css
	var jsEditor = ace.edit('aceJSEditorDiv');
	jsEditor.getSession().setMode("ace/mode/javascript");
	jsEditor.setTheme("ace/theme/chrome");
	jsEditor.setShowFoldWidgets(false);
	jsEditor.getSession().on('change', onEditorChanged);
	var hasjsErrors = false;
	var firepad = Firepad.fromACE(jsFirebaseRef, jsEditor, 
		{ defaultText: 'go(); \n\nfunction go() {\n  var message = "Hello, world.";\n  console.log(message);\n}' });

	var htmlEditor = ace.edit('aceHTMLEditorDiv');
	htmlEditor.getSession().setMode("ace/mode/html");
	htmlEditor.setTheme("ace/theme/chrome");
	htmlEditor.setShowFoldWidgets(false);
	htmlEditor.getSession().on('change', onEditorChanged);
	var hashtmlErrors = false;
	var firepad = Firepad.fromACE(htmlFirebaseRef, htmlEditor, 
		{ defaultText: '<!DOCTYPE html>\n<html>\n<head>\n\t<meta charset="utf-8">\n\t<title>Coode</title>\n</head>\n'
						+ '<body>\n\n</body>\n</html>' });

	var cssEditor = ace.edit('aceCSSEditorDiv');
	cssEditor.getSession().setMode("ace/mode/css");
	cssEditor.setTheme("ace/theme/chrome");
	cssEditor.setShowFoldWidgets(false);
	cssEditor.getSession().on('change', onEditorChanged);
	var hascssErrors = false;
	var firepad = Firepad.fromACE(cssFirebaseRef, cssEditor, 
		{ defaultText: '' });	
	
	// Subscribe to annotation changes
	jsEditor.getSession().on("changeAnnotation", function(){
		// Look through the JSON structure of annotations. If there is any annotation that is an error,
		// set the error flag and halt.
    	var annot = jsEditor.getSession().getAnnotations();
    	for (var key in annot)
    	{
        	if (annot.hasOwnProperty(key) && annot[key].type == 'error')
        	{
        		console.log("has js errors");
        		hasjsErrors = true;
        		return;
        	}        
    	}
    	hasjsErrors = false;
    });
	
	
    // Intercept calls to console.log and output them to the console window      
    (function () {
  	  var log = console.log;
  	  console.log = function () {
  		$('#console-output').append(Array.prototype.slice.call(arguments) + '<BR>');  
  	    log.apply(this, Array.prototype.slice.call(arguments));
  	  };
  	}());
    
    // Activate tabs in code UI
    $('#jsTab a').click(function (e) {
	  e.preventDefault();
	  $(this).tab('show');
	});
    $('#htmlTab a').click(function (e) {
  	  e.preventDefault();
  	  $(this).tab('show');
  	});
    $('#cssTab a').click(function (e) {
  	  e.preventDefault();
  	  $(this).tab('show');
  	});
    
</script>

</body>
</html>